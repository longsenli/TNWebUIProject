<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="user-scalable=0">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>天能（濮阳）</title>

		<!-- CSS -->
		<!-- <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:400,100,300,500"> -->
		<link rel="stylesheet" href="../vendor/bootstrap/css/bootstrap.min.css">
		<link rel="stylesheet" href="../vendor/font-awesome/css/font-awesome.min.css">
		<link rel="stylesheet" href="../vendor/login/css/form-elements.css">
		<link rel="stylesheet" href="../vendor/login/css/style.css">

		<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

		<!-- Favicon and touch icons -->
		<!-- <link rel="shortcut icon" href="../vendor/login/ico/favicon.png"> -->
		<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../vendor/login/ico/apple-touch-icon-144-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../vendor/login/ico/apple-touch-icon-114-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../vendor/login/ico/apple-touch-icon-72-precomposed.png">
		<!-- <link rel="apple-touch-icon-precomposed" href="../vendor/login/ico/apple-touch-icon-57-precomposed.png"> -->

		<!-- Javascript -->
		<!--<script src="../vendor/jquery/jquery.min.js"></script>-->
		<script src="../vendor/jquery/jquery.min.js"></script>
		<script src="../vendor/jquery/jquery.cookie.js"></script>

		<script src="../vendor/login/js/jquery.backstretch.min.js"></script>
		<script src="../vendor/bootstrap/js/bootstrap.min.js"></script>

		<script src="../vendor/login/js/scripts.js"></script>
		<script src="../js/common.js"></script>
	</head>

	<body onload="appLoginPageload();">

		<!-- Top content -->
		<div class="top-content">
			<div class="container">
				<div class="row">
					<div class="col-sm-8 col-sm-offset-2 text">
						<h3><font color="#FFFFFF">智能制造精益生产系统</font></h3>
						<!-- <p>
								为了让我们的生产流程信息化、智能化而不断努力！
							</p> -->
					</div>
				</div>
				<div class="row">
					<div class="col-sm-6 col-sm-offset-3 form-box">
						<div class="form-top">
							<div class="form-top-left">
								<h3>系统登录</h3>
								<p id="hintinfo">请输入您的用户名和密码：</p>
							</div>
							<div class="form-top-right">
								<i class="fa fa-key"></i>
							</div>
						</div>
						<div class="form-bottom">
							<form action="" method="post" class="login-form" onsubmit="return login()">
								<div class="form-group">
									<!--    		<label class="sr-only" for="form-username">Username</label>-->
									<input type="text" name="form-username" placeholder="用户名" class="form-username form-control" id="form-username" required>
								</div>
								<div class="form-group">
									<!--<label class="sr-only" for="form-password">Password</label>-->
									<input type="password" name="form-password" placeholder="密码" class="form-password form-control" id="form-password" required>
								</div>
								<!--    <a href="index.html" class="btn btn-lg btn-success btn-block">登录</a>-->
								<button type="submit" class="btn">登录</button>
							</form>
							<div align="right" style="padding-top: 10px;">
								<a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
									<i style="font-size: x-large;color: #3C763D" class="fa fa-cog"></i>
									<span style="font-size: x-large;color: #3C763D">设置</span></a>
							</div>
							<div id="collapseTwo" class="panel-collapse collapse">
								<input type="text" onblur="setRemoteServiceIP()" name="RemoteServiceIP" placeholder="设置服务器信息" class="form-username form-control" id="RemoteServiceIP" required>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!--[if lt IE 10]>
            <script src="assets/js/placeholder.js"></script>
        <![endif]-->
		<script type="text/javascript">
			$(function() {
				document.addEventListener('plusready', function() {
					// 在这里调用5+ API 
					versionCompare();
				}, false);
			});

			function setRemoteServiceIP() {
				var RemoteServiceIP = $("#RemoteServiceIP").val();
				localStorage.setItem('RemoteServiceIP', RemoteServiceIP);
			}

			function appLoginPageload() {
				$("#form-username").val(localStorage.getItem('LocalUserName'));
				$("#form-password").val(localStorage.getItem('LocalUserPsw'));
				$("#RemoteServiceIP").val(localStorage.getItem('RemoteServiceIP'));

			}

			function versionCompare() {
				var RemoteServiceIP1 = localStorage.getItem('RemoteServiceIP');
				if(RemoteServiceIP1 != null && RemoteServiceIP1 != 'undefined' && RemoteServiceIP1 != "") {
					window.serviceIP = 'http://' + RemoteServiceIP1 + '/ilpsService';
				}
				var versionNow;
				plus.runtime.getProperty(plus.runtime.appid, function(inf) {
					versionNow = inf.version;
				});

				$.ajax({
					type: "get",
					url: window.serviceIP + '/api/getappversionbyclienttype?clientType=apk',
					async: true,
					success: function(res) {

						//alert(res.message)
						if(res.message > versionNow) //比对版本号
						{
							//console.log(new_version+'新版本'+version);
							plus.nativeUI.confirm("应用有新版本，是否立即下载更新？", function(event) {
								if(event.index == 1) {
									plus.nativeUI.showWaiting();
									//updateAppRun(window.webUiService + '/pages/H5EE481DB_0308142119.apk');
									updateAppRun(window.serviceIP + '/tnpyILPS_' + res.message.toString().trim() + '.apk');
									
									//updateAppRun("http://fast.yingyonghui.com/82576ac98a5bf68aa822332c681ce0d9/5c84684a/apk/6363734/4e788c5e4446c6edece446bc92eef0af");
									//ks.update_ksd(new_json.url); //更新函数,在下面

								}
							}, '更新确认', ['取消', '确认']);
						}
					}
				});

			}
			//ks.update_ksd==========
			function updateAppRun(url) {
				//console.log(url);
				//创建下载管理对象
				var dtask = plus.downloader.createDownload(url, {}, function(d, status) {
					// 下载完成
					if(status == 200) { //下载成功后的回调函数
						//alert("下载成功，准备安装" + d.filename)
						plus.nativeUI.toast("下载成功，准备安装" + d.filename);
						//console.log(d);
						//安装程序，第一个参数是路径，默认的下载路径在_downloads里面
						//plus.runtime.install('_downloads/ksd.apk', {}, function() {
						plus.runtime.install(d.filename, {}, function() {
							plus.nativeUI.toast('安装成功');
						}, function() {
							plus.nativeUI.toast('安装失败');
						});
						plus.nativeUI.closeWaiting();
					} else {
						alert("下载失败 " + status);
						plus.nativeUI.closeWaiting();
					}
				});
				//dtask.addEventListener( "statechanged", onStateChanged, false );
				dtask.start(); //开始下载任务
			}

			function login() {

				var username = document.getElementById("form-username").value;
				var password = document.getElementById("form-password").value;
				var RemoteServiceIP1 = localStorage.getItem('RemoteServiceIP');
				if(RemoteServiceIP1 != null && RemoteServiceIP1 != 'undefined' && RemoteServiceIP1 != "") {
					window.serviceIP = 'http://' + RemoteServiceIP1 + '/ilpsService';
				}
				$.ajax({
					type: 'POST',
					url: window.serviceIP + '/api/login',
					dataType: "json",
					data: {
						'username': username,
						"password": password
					},
					async: true, //设置为false时,timeout不生效
					timeout: 5000,
					success: function(result) {
						if(result.status == "1") {
							// console.log(result)
							// var login_info = null;
							// 							login_info = login_info || {};
							// 							login_info.token = result.token || '';
							// 							login_info.username = result.message.split("###")[0].trim() || '';
							// 							login_info.userID = username || '';
							// 							login_info.roleID = result.message.split("###")[1].trim() || '';
							// 							login_info.password = password || '';
							//登陆成功后获取token
							var token = JSON.parse(result.token);
							token.username = result.message.split("###")[0].trim() || '';
							token.userID = username || '';
							token.roleID = result.message.split("###")[1].trim() || '';
							token.password = password || '';

							// 							login_info = {
							// 								'token':result.token,
							// 								'username':result.message.split("###")[0].trim(),
							// 								'userID':username,
							// 								'roleID':result.message.split("###")[1].trim(),
							// 								'password': password
							// 							};
							// localStorage.setItem('Global_UserLogin_Info',Global_UserLogin_Info);
							// alert(localStorage.getItem('$users'))

							// 							$.cookie('username', result.message.split("###")[0].trim());
							// 							$.cookie('userID', username);
							// 							$.cookie('roleID', result.message.split("###")[1].trim());
							// 							$.cookie('password', password);

							if(result.message.split("###")[2].trim() != "-1" && result.message.split("###")[2].trim() != "null" && result.message.split("###")[2].trim().length > 1) {
								// $.cookie('plantID', result.message.split("###")[2].trim());
								token.plantID = result.message.split("###")[2].trim();
							}
							if(result.message.split("###")[3].trim() != "-1" && result.message.split("###")[3].trim() != "null" && result.message.split("###")[3].trim().length > 1) {
								// $.cookie('processID', result.message.split("###")[3].trim());
								token.processID = result.message.split("###")[3].trim();
							}
							if(result.message.split("###")[4].trim() != "-1" && result.message.split("###")[4].trim() != "null" && result.message.split("###")[4].trim().length > 1) {
								// $.cookie('lineID', result.message.split("###")[4].trim());
								token.lineID = result.message.split("###")[4].trim();
							}
							// alert(JSON.stringify(token));
							// 							var Global_UserLogin_Info = [];
							// 							Global_UserLogin_Info.push(login_info);
							//将全局token等信息放入变量$Global_UserLogin_Info
							localStorage.setItem('$Global_UserLogin_Info', JSON.stringify(token));
							localStorage.setItem("LocalUserName", username);
							localStorage.setItem("LocalUserPsw", password);
							// 							var aa = localStorage.getItem('$Global_UserLogin_Info');
							// 							alert(aa.token)
							// 							var users = JSON.parse(localStorage.getItem('$Global_UserLogin_Info'));
							// 							alert(users.token)
							if(result.message.split("###")[1].trim() == "24") {
								window.location.href = "app_productionIndex.html";
							} else {
								window.location.href = "app_productionIndex.html";
							}

						} else {
							var hintinfo = document.getElementById("hintinfo");
							hintinfo.innerText = "用户名或密码错误，请重新填写。";
						}
					},

					error: function(xhr, status, err) {
						//					 	alert('出现错误,请联系管理员!')
					},
					complete: function(XMLHttpRequest, status) { //当请求完成时调用函数

						if(status == 'timeout') { //status == 'timeout'意为超时,status的可能取值：success,notmodified,nocontent,error,timeout,abort,parsererror 
							alert(status + "网络连接超时, 请检查网络")
						}
					}

				});
				return false;
			}
		</script>
	</body>

</html>