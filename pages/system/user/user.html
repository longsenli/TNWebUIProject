<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<script type="text/javascript" src="../../../vendor/jquery/jquery.min.js"></script>
		<script type="text/javascript" src="../../../vendor/jquery/jquery.cookie.js"></script>
		<script type="text/javascript" src="../../../vendor/bootstrap/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="../../../vendor/boostrap-select/bootstrap-select.min.js"></script>
		<script type="text/javascript" src="../../../vendor/bootstrap-datatable/bootstrap-table.js"></script>
		<script type="text/javascript" src="../../../js/common.js"></script>
		<script type="text/javascript" src="../../../vendor/bootstrap-datatable/bootstrap-table-zh-CN.js"></script>
		<script type="text/javascript" src="../../../vendor/jquery/ztree/js/jquery.ztree.core.js"></script>
		<script type="text/javascript" src="../../../vendor/jquery/ztree/js/jquery.ztree.excheck.js"></script>
		<link rel="stylesheet" type="text/css" href="../../../vendor/jquery/ztree/css/bootstrapStyle/bootstrapStyle.css" >
		<link rel="stylesheet" type="text/css" href="../../../vendor/bootstrap/css/bootstrap.min.css" media="screen">
		<link rel="stylesheet" type="text/css" href="../../../vendor/boostrap-select/bootstrap-select.min.css" media="screen">
		<link rel="stylesheet" type="text/css" href="../../../vendor/bootstrap-datatable/bootstrap-table.css" media="screen">
	</head>
<body>
		<section class="content table-content">
			<form class="form-inline" >
			<!-- 工具栏 -->
			<div id="toolbar">
					<!--<input type="button" value="新增用户" id="addBtn" data-toggle="modal" data-target="#addUserModal" class="btn btn-success"></input>
					<input type="button" value="修改用户" id="editBtn" data-toggle="modal" data-target="#editUserModal" class="btn btn-warning" onclick="editUser()"></input>
					<input type="button" value="删除用户" id="deleteBtn" data-toggle="modal" data-target="#confirmDelModal" class="btn btn-danger" ></input>-->
					<button type="button" class="btn btn-success" data-toggle="modal" data-target="#addUserModal">
		              <i class="glyphicon glyphicon-plus" aria-hidden="true">新增用户</i>
		            </button>
		            <button type="button" class="btn btn-warning" onclick="editUser()">
		              <i class="glyphicon glyphicon-edit" aria-hidden="true">修改用户</i>
		            </button>
		            <button type="button" class="btn btn-danger"  onclick="confirmDel()">
		              <i class="glyphicon glyphicon-remove" aria-hidden="true">删除用户</i>
		            </button>
			</div>
			<!-- bootstrapTable -->
			</form>
			<table id="dataGrid">
			</table>
		</section>
		<!-- 新增用户的模态框，在修改用户中将获取一行的值放入input中，改变一些参数继续使用 -->
		<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h3>新增用户</h3>
					</div>
					<div class="modal-body">
						<form id="addUserForm" action="" method="post" class="form-horizontal">
							<div class="form-group">
								<label for="inputAccount" class="col-sm-2 control-label">登录名</label>
								<div class="col-sm-7">
									<input type="account" name="userid" class="form-control" id="inputUserId" placeholder="登录名"/>
								</div>
								<label id="errorAccount" for="inputAccount" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group" >
								<label for="inputPassword" class="col-sm-2 control-label">密码</label>
								<div class="col-sm-7">
									<input type="text" name="password" class="form-control" id="inputPassword" placeholder="密码"/>
								</div>
								<label id="errorPassword" for="inputPassword" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group">
								<label for="inputName" class="col-sm-2 control-label">姓名</label>
								<div class="col-sm-7">
									<input type="name" name="name" class="col-sm-4 form-control" id="inputName" placeholder="姓名"/>
								</div>
								<label id="errorName" for="inputName" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group">
								<label for="inputSex" class="col-sm-2 control-label">性别</label>
								<div class="col-sm-7">
									<input type="sex" name="sex" class="col-sm-4 form-control" id="inputSex" placeholder="性别"/>
								</div>
								<label id="errorSex" for="inputSex" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group">
								<label for="inputPhone" class="col-sm-2 control-label">手机</label>
								<div class="col-sm-7">
									<input type="phone" name="mobilephone" class="col-sm-4 form-control" id="mobilephone" placeholder="手机"/>
								</div>
								<label id="errorPhone" for="inputPhone" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group">
								<label for="inputPhone" class="col-sm-2 control-label">办公固话</label>
								<div class="col-sm-7">
									<input type="phone" name="telephone" class="col-sm-4 form-control" id="telephone" placeholder="办公固话"/>
								</div>
								<label id="errorPhone" for="inputPhone" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group">
								<label for="inputEmail" class="col-sm-2 control-label">邮箱</label>
								<div class="col-sm-7">
									<input type="email" name="email" class="col-sm-4 form-control" id="inputEmail" placeholder="邮箱"/>
								</div>
								<label id="errorEmail" for="inputEmail" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group">
								<label for="inputPhone" class="col-sm-2 control-label">用户角色</label>
								<div class="col-sm-7">
									<input id="addRoleId" name="roleid" value="0" type="hidden"  />
									<input class="form-control" type="text" onclick="addListRole()" id="addRoleName" name="roleName" placeholder="点击选择" readonly="true" />
								</div>
								<label id="errorPhone" for="inputPhone" class="col-sm-3 control-label"></label>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" id="conf" class="btn btn-success" onclick="addUser()">确定</button>
						<button type="button" class="btn btn-danger" data-dismiss="modal" onclick="resetAddModal()">取消</button>
					</div>
				</div>				
			</div>
		</div>
		<div class="modal fade" id="addListRoleModal" Menu="dialog">
			<div class="modal-dialog" Menu="document">
				<div class="modal-content">
					<div class="modal-header">
						<h3>角色列表</h3>
					</div>
					<div class="modal-body" align="center">
						<div class="content_wrap">
							<div class="zTreeDemoBackground left">
								<ul id="addListRoleTree" class="ztree"></ul>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-success"  >提交</button>
						<button type="button" class="btn btn-danger" data-dismiss="modal" onclick="">取消</button>
					</div>
				</div>
			</div>
		</div>
<!-- 修改用户的模态框 -->
		<div class="modal fade" id="editModal" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h3>修改用户</h3>
					</div>
					<div class="modal-body">
						<form id="editForm" method="post" class="form-horizontal">
							<div class="form-group" style="">
								<label for="editId" class="col-sm-2 control-label">登录名</label>
								<div class="col-sm-7">
									<input type="text" name="userid"   class="form-control" id="editUserid" placeholder="登录名" />
								</div>
								<label id="errorId" for="editId" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group" >
								<label for="inputPassword" class="col-sm-2 control-label">密码</label>
								<div class="col-sm-7">
									<input type="text" name="password" class="form-control" id="editPassword" placeholder="密码"/>
								</div>
								<label id="errorPassword" for="inputPassword" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group">
								<label for="inputName" class="col-sm-2 control-label">姓名</label>
								<div class="col-sm-7">
									<input type="name" name="name" class="col-sm-4 form-control" id="editName" placeholder="姓名"/>
								</div>
								<label id="errorName" for="inputName" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group">
								<label for="inputSex" class="col-sm-2 control-label">性别</label>
								<div class="col-sm-7">
									<input type="sex" name="sex" class="col-sm-4 form-control" id="editSex" placeholder="性别"/>
								</div>
								<label id="errorSex" for="inputSex" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group">
								<label for="inputPhone" class="col-sm-2 control-label">手机</label>
								<div class="col-sm-7">
									<input type="phone" name="mobilephone" class="col-sm-4 form-control" id="editMobilePhone" placeholder="手机"/>
								</div>
								<label id="errorPhone" for="inputPhone" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group">
								<label for="inputEmail" class="col-sm-2 control-label">邮箱</label>
								<div class="col-sm-7">
									<input type="email" name="email" class="col-sm-4 form-control" id="editEmail" placeholder="邮箱"/>
								</div>
								<label id="errorEmail" for="inputEmail" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group">
								<label for="inputStates" class="col-sm-2 control-label">状态</label>
								<div class="col-sm-7">
									<input type="states" name="state" class="col-sm-4 form-control" id="editStates" placeholder="状态"/>
								</div>
								<label id="errorStates" for="inputStates" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group" style="display:none">
								<label for="inputCreated_at" class="col-sm-2 control-label">创建时间</label>
								<div class="col-sm-7">
									<input type="created_at" name="created_at" class="col-sm-4 form-control" id="editCreated_at" placeholder="创建时间" />
								</div>
								<label id="errorCreated_at" for="inputCreated_at" class="col-sm-3 control-label"></label>
							</div>
							<div class="form-group">
								<label for="inputPhone" class="col-sm-2 control-label">用户角色</label>
								<div class="col-sm-7">
									<input id="editRoleId" name="roleid" value="0" type="hidden"  />
									<input class="form-control" type="text" onclick="editListRole()" id="editRoleName" name="roleName" placeholder="点击选择" readonly="true" />
								</div>
								<label id="errorPhone" for="inputPhone" class="col-sm-3 control-label"></label>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" id="conf" class="btn btn-success" onclick="updateUser()">提交</button>
						<button type="button" class="btn btn-danger" data-dismiss="modal" onclick="resetAddModal()">取消</button>
					</div>
				</div>				
			</div>
		</div>
		<div class="modal fade" id="editListRoleModal" Menu="dialog">
			<div class="modal-dialog" Menu="document">
				<div class="modal-content">
					<div class="modal-header">
						<h3>角色列表</h3>
					</div>
					<div class="modal-body" align="center">
						<div class="content_wrap">
							<div class="zTreeDemoBackground left">
								<ul id="editListRoleTree" class="ztree"></ul>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-success"  >确定</button>
						<button type="button" class="btn btn-danger" data-dismiss="modal" onclick="">取消</button>
					</div>
				</div>
			</div>
		</div>
		<div class="modal fade" id="Tip" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h3>提示</h3>
					</div>
					<div class="modal-body" align="center">
						<h4 id="tipContent">新增成功</h4>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-warning" data-dismiss="modal">确定</button>
					</div>
				</div>
			</div>
		</div>
		<div class="modal fade" id="updateEnd" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h3>提示</h3>
					</div>
					<div class="modal-body" align="center">
						<h4 id="al">修改成功</h4>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">确定</button>
					</div>
				</div>
			</div>
		</div>
		<div class="modal fade" id="confirmDelModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
			  <div class="modal-dialog" role="document">
			    <div class="modal-content">
			      <div class="modal-header">
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
			        <h4 class="modal-title" id="exampleModalLabel">确认框</h4>
			      </div>
			      <div class="modal-body">
			        <form>
							<input id="delMenuId" name="parentId" type="hidden"  />
			       	<div class="form-group">
			            <label for="message-text" class="control-label">确定要删除吗？</label>
			          </div>
			        </form>
			      </div>
			      <div class="modal-footer">
			        <button type="button" class="btn btn-success" data-dismiss="modal">取消</button>
			        <button type="button" class="btn btn-danger"  data-dismiss="modal" onclick="deleteUser()">确认</button>
			      </div>
			    </div>
			  </div>
		</div>
</body>

</html>


<script type="text/javascript">
/*初始化方法*/
initDataGrid();
function initDataGrid(){
	var columnsArray = [];
	columnsArray.push({
		checkbox: true
	});
	columnsArray.push({
		"title": "登录名",
		"field": "userid",
		// "visible":false
	});
	columnsArray.push({
		"title": "状态",
		"field": "state",
		align: 'center',
		formatter: function(value, row, index) {
			// console.log(row);
			if (value == '1') {
				return '<span class="badge badge-primary">正常</span>';
			} else if (value == '0') {
				return '<span class="badge badge-danger">停用</span>';
			}
		}
	});
	columnsArray.push({
		"title": "姓名",
		"field": "name"
	});
	columnsArray.push({
		"title": "性别",
		"field": "sex",
		// visible: false
	});
	columnsArray.push({
		"title": "手机",
		"field": "mobilephone",
		// visible: false
	});
	columnsArray.push({
		"title": "邮箱",
		"field": "email",
		// visible: false
	});
	columnsArray.push({
		"title": "roleid",
		"field": "roleid",
		visible: false
	});
	columnsArray.push({
		"title": "用户角色",
		"field": "roleName",
		// visible: false
	});
	$.ajax({
		url: window.serviceIP + "/user/pageInfo",
		type: "POST",
		contentType: "application/json",
		dataType: "json",
		//		headers: {
		//			Token: $.cookie('token')
		//		},
		processData: true,
		success: function(dataRes) {
			if(dataRes.status == 1) { 
				var models = eval("(" + dataRes.data + ")");
				// console.log(models);
				$('#dataGrid').bootstrapTable('destroy').bootstrapTable({
					data: models,
					toolbar: '#toolbar',
					singleSelect: true,
					clickToSelect: true,
					sortName: "recordTime",
					sortOrder: "desc",
					pageSize: 15,
					pageNumber: 1,
					pageList: "[10, 25, 50, 100, All]",
					showToggle: true,
					showRefresh: true,
					showColumns: true,
					search: true,
					pagination: true,
					columns: columnsArray
				});
			} else {
				alert("初始化数据失败！" + dataRes.message);
			}
		}
	});
}
			//点击取消后清空表单中已写信息
			function resetAddModal(){
				document.getElementById("addUserForm").reset();
			}
			
			
			function confirmDel(){
				//获取选中行的数据
				var rows = $("#dataGrid").bootstrapTable('getSelections');
				if(rows.length!=1){
					document.getElementById("tipContent").innerText="请选择一行数据";
					$("#Tip").modal('show');
				}
				else{
					$("#confirmDelModal").modal('show');
				}
			}
			
		/**
		 * 删除用户
		 */
		function deleteUser(){
				var rows = $("#dataGrid").bootstrapTable("getSelections");
				var ids = [];
				var len = rows.length;
				// alert(len);
				
				debugger;
				for(var i=0;i<len;i++){
					ids.push(rows[i].userid);
				}
				// alert(ids);
				debugger;
				$.ajax({
					url:window.serviceIP + "/user/deleteUser",
					dataType:"json",
					traditional: true,//属性在这里设置
					method:"post",
					data:{
						"ids":ids
					},
					success:function(data){
						// alert(data.state);
						if(data.state == 'success'){
							alert('删除成功');
							initDataGrid();
						}
// 						document.getElementById("tipContent").innerText="删除成功";
// 						$("#Tip").modal('show');
						
						// $("#dataGrid").bootstrapTable("refresh");
					},
					error:function(){
						document.getElementById("tipContent").innerText="删除失败";
						$("#Tip").modal('show');
					}
				});
			}
		

</script>

<!-- 新增用户使用js-->
<script>
	//新增页面设置ztree setting
	var addsetting = {
		view:{selectedMulti:false},
		data: {
			simpleData: {
				enable: true,
// 						idKey: "roleId",
// 						pIdKey: "parentId",
// 						name: "roleName",
				// rootPId: 0
			}},
		callback:{onClick:addSetRole
		}
	};
	/*新增用户modal加载角色展示tree*/
	function addListRole() {
	 // var allTableData = $("#dataGrid").bootstrapTable('getData');//获取表格的所有内容行
	 // var zNodes = new Array(allTableData.length);
	 var zNodes = new Array();
	 $.ajax({
			type : 'POST',
			url : window.serviceIP+ '/role/listRoles',
			dataType: "json",
			async:false,
			success : function(rs){
				var result = eval("("+rs.data+")");
				for( i=0;i<result.length;i++)
					{
						zNodes[i]={id:result[i].roleId, name:result[i].roleName };	
					}
					$.fn.zTree.init($("#addListRoleTree"), addsetting, zNodes);
					$("#addListRoleModal").modal('show');
			}
		});
	}
	/*新增页面设置用户角色方法*/
	function addSetRole(event, treeId, treeNode){
		var treeId = treeNode.id;
		var treeName = treeNode.name;
		$("#addListRoleModal").modal('hide');
		// alert($("#addParentId").val());
		// alert(treeId);
		$("#addRoleId").val(treeId);
		$("#addRoleName").val(treeName);
	}
	//新增用户
	function addUser(){
		var param = $("#addUserForm").serializeArray();
		debugger;
		$("#conf").attr("onclick","addUser()");
		$.ajax({
			url: window.serviceIP + "/user/addUser",
			method:"post",
			data:param,
			dataType:"json",
			success:function(data){
				// alert("新增成功");
				if(data.status=="1"){
					// document.getElementById("al").innerText="保存成功";
					alert("保存成功");
					document.getElementById("addUserForm").reset();
					// console.log(data);
					// $("#Tip").modal('show');
					$("#addUserModal").modal('hide');
					initDataGrid();
					// $("#dataGrid").bootstrapTable('refresh');
				}
				else{
					alert("保存失败!");
				}
			},
			error:function(){
				document.getElementById("al").innerText="新增失败";
				$("#addEnd").modal('show');
			}
		});
	}
</script>
<!-- 修改用户使用js-->
<script>
	//修改页面设置ztree setting
	var editsetting = {
		view:{selectedMulti:false},
		data: {
			simpleData: {
				enable: true,
// 						idKey: "roleId",
// 						pIdKey: "parentId",
// 						name: "roleName",
				// rootPId: 0
			}},
		callback:{onClick:editSetRole
		}
	};
	/*修改用户modal加载角色展示tree*/
	function editListRole() {
	 // var allTableData = $("#dataGrid").bootstrapTable('getData');//获取表格的所有内容行
	 // var zNodes = new Array(allTableData.length);
	 var zNodes = new Array();
	 $.ajax({
			type : 'POST',
			url : window.serviceIP+ '/role/listRoles',
			dataType: "json",
			async:false,
			success : function(rs){
				var result = eval("("+rs.data+")");
				for( i=0;i<result.length;i++)
					{
						zNodes[i]={id:result[i].roleId, name:result[i].roleName };	
					}
					$.fn.zTree.init($("#editListRoleTree"), editsetting, zNodes);
					$("#editListRoleModal").modal('show');
			}
		});
	}
	/*修改页面设置用户角色方法*/
	function editSetRole(event, treeId, treeNode){
		var treeId = treeNode.id;
		var treeName = treeNode.name;
		$("#editListRoleModal").modal('hide');
		// alert($("#addParentId").val());
		alert(treeId);
		$("#editRoleId").val(treeId);
		$("#editRoleName").val(treeName);
	}
	//修改用户提交方法
	function editUser(){
		//获取选中行的数据
		var rows = $("#dataGrid").bootstrapTable('getSelections');
		if(rows.length!=1){
			document.getElementById("tipContent").innerText="请选择一行数据";
			$("#Tip").modal('show');
		}
		else{
		var row = rows[0];
		$('#editUserid').val(row.userid);
		$('#editLoginname').val(row.loginname);
		// alert(row.loginname);
		$('#loginname').innerText = row.loginname;
		$('#editPassword').val(row.password);
		$('#editName').val(row.name);
		$('#editSex').val(row.sex);
		$('#editEmail').val(row.email);
		$('#editMobilePhone').val(row.mobilephone);
		$('#editStates').val(row.state);
		$('#editCreated_at').val(row.created_at);
		$('#editRoleId').val(row.roleid);
		$('#editRoleName').val(row.roleName);
		$("#editModal").modal("show");
		}
	}
	function updateUser(){
		var param = $("#editForm").serializeArray();
		//设为disable则无法获取
		$.ajax({
			url:window.serviceIP + "/user/updateUser",
			method:"post",
			data:param,
			dataType:"json",
			success:function(data){
				if(data.status=="1"){
					$("#editModal").modal("hide");
					document.getElementById("tipContent").innerText="修改成功";
					$("#Tip").modal('show');
					initDataGrid();
				}
			},
			error:function(data){
				alert("修改失败");
			}
		});
	}
</script>